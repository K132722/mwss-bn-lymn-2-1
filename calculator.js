// calculator.js

document.addEventListener('DOMContentLoaded', function() {
    // ูุชุบููุฑุงุช ุงูุชุทุจูู
    let calculatorOpen = false;
    let isDragging = false;
    let startX, startY, offsetX, offsetY;
    let isDraggingScroll = false;
    let startScrollX, scrollLeft;

    // ูุชุบููุฑุงุช ุงูุฃุฑุดูู (history)
    let sessions = [];
    let history = [];

    // ูู ุดุงุดุฉ ูุนุฑูููุง ููุฌุฑูุฏ ูุงุฆู ูุญุชูู ุนูู ุงูุนูุตุฑูู: displayElement ู resultElement
    let screens = [];
    let activeScreen = null;   // ุงููุงุฆู ุงูุฐู ูุดูุฑ ุฅูู ุงูุดุงุดุฉ ุงูุญุงููุฉ (editable)
    let caretPos = 0;          // ููุถุน ุงููุคุดุฑ ูู ุดุงุดุฉ ุงูุฅุฏุฎุงู ุงูุญุงููุฉ
    let currentExpr = '';      // ุงูุชุนุจูุฑ ุงูุฌุงุฑู ุฅุฏุฎุงูู ูู ุงูุดุงุดุฉ ุงูุญุงููุฉ

    // ุฅูุดุงุก ุนูุงุตุฑ DOM ูุฒุฑ ุงูุญุงุณุจุฉ ูุงูุฃุฑุดูู ูุงูุขูุฉ ุงูุญุงุณุจุฉ
    const calcTab = document.createElement('div');
    calcTab.className = 'calc-tab';
    calcTab.id = 'calcTab';
    calcTab.innerHTML = '<i class="fas fa-calculator"></i>';
    // ูุถุจุท ูููุน ุฒุฑ ุงูุญุงุณุจุฉ ุงูุงุจุชุฏุงุฆู
    calcTab.style.left = '20px';
    calcTab.style.bottom = '20px';
    calcTab.style.position = 'fixed';
    calcTab.style.zIndex = '1000'; // ุฃุนูู ูู ุงูุฃููุฑูุงู

    const historyPanel = document.createElement('div');
    historyPanel.className = 'history-panel';
    historyPanel.id = 'historyPanel';
    historyPanel.innerHTML = `
        <div class="history-header">
            <div class="history-title">ุงูุฃุฑุดูู (0)</div>
            <button class="history-clear" id="historyClear">
                <i class="fas fa-trash"></i>
            </button>
            <button class="history-close" id="historyClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="history-controls">
            <input type="text" id="historySearch" placeholder="ุจุญุซ ูู ุงูุฃุฑุดูู...">
        </div>
        <div id="historyItems"></div>
    `;
    // ูุฌุนู ุงูุฃุฑุดูู ููู ุงูุญุงุณุจุฉ ูุจุงุดุฑุฉ
    historyPanel.style.zIndex = '1003';
    // ููุบู ุฃู ุงูุชูุงู ูุฌุนู ุงููุชุญ ููุฑูููุง
    historyPanel.style.transition = 'none';

    const calculatorContainer = document.createElement('div');
    calculatorContainer.className = 'calculator-container';
    calculatorContainer.id = 'calculatorContainer';
    calculatorContainer.style.zIndex = '1000'; // ุฃูู ูู ุงูุฒุฑ ุญุชู ูุง ูุญุฌุจ ุงูุฃุฒุฑุงุฑ
    // ููุบู ุงูุงูุชูุงู ุงูุฃููู ุญุชู ูุง ูููุฑู ุงูุญุงููุฉ ุฃุซูุงุก ุงูุชุญููู
    calculatorContainer.style.transition = 'none';
    calculatorContainer.innerHTML = `
        <div class="calculator-header">
        <img src="png 2.png" class="result-logo1" alt="ุดุนุงุฑ ุงููุคุณุณุฉ">

            <!-- ุงุณู ุงููุคุณุณุฉ ุจุดูู ูุณุชูู -->
            <div class="result-inst1">
              ูุคุณุณุฉ ุจูุงุก ุงูููู<br>
              ููููููุญุฏููููููุฏ ุงูููุชุณูููููููุญ

          </div>
            <div class="calculator-title">ุงูุญุงุณุจุฉ</div>
            <button class="calculator-close" id="calculatorClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="calc-screens-container" id="calcScreensContainer">
            <!-- ููุง ุณุชุธูุฑ ูู ุดุงุดุงุช ุงูุนูููุงุช (ุงูุณุงุจู ูููุง ูุงูุญุงูู) -->
        </div>
        <div class="arrow-controls">
            <div class="arrow-row">
                <button class="arrow-btn right" onclick="moveCaret('right')">โถ</button>
                <button class="arrow-btn left" onclick="moveCaret('left')">โ</button>
            </div>
            <div class="arrow-row">
                <button class="arrow-btn down" onclick="moveCaret('down')">โผ</button>
                <button class="arrow-btn up" onclick="moveCaret('up')">โฒ</button>
            </div>
        </div>
        <div class="calculator-buttons">
            <!-- ุงูุตู ุงูุฃูู -->
            <button class="calc-button clear" onclick="clearCurrentExpr()">C</button>
            <button class="calc-button function" onclick="deleteLastChar()">โซ</button>
            <button class="calc-button" onclick="press('9')">9</button>
            <button class="calc-button" onclick="press('8')">8</button>
            <button class="calc-button" onclick="press('7')">7</button>
            <!-- ุงูุตู ุงูุซุงูู -->
            <button class="calc-button operator" onclick="press('/')">รท</button>
            <button class="calc-button operator" onclick="press('*')">ร</button>
            <button class="calc-button" onclick="press('6')">6</button>
            <button class="calc-button" onclick="press('5')">5</button>
            <button class="calc-button" onclick="press('4')">4</button>
            <!-- ุงูุตู ุงูุซุงูุซ -->
            <button class="calc-button operator" onclick="press('-')">-</button>
            <button class="calc-button operator" onclick="press('+')">+</button>
            <button class="calc-button" onclick="press('3')">3</button>
            <button class="calc-button" onclick="press('2')">2</button>
            <button class="calc-button" onclick="press('1')">1</button>
            <!-- ุงูุตู ุงูุฑุงุจุน -->
            <button class="calc-button equal" id="equalButton">=</button>
            <button class="calc-button function" onclick="insertAns()">Ans</button>
            <button class="calc-button" onclick="press('.')">.</button>
            <button class="calc-button" onclick="press('00')">00</button>
            <button class="calc-button" onclick="press('0')">0</button>
        </div>
        <!-- ูุงูุฐุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ -->
        <div id="backupModal" class="backup-modal">
          <h3>๐ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ</h3>
          <textarea id="backupText"></textarea>
          <div class="modal-actions">
            <button id="copyBackupBtn">๐ ูุณุฎ</button>
            <button id="closeBackupBtn">โ ุฅุบูุงู</button>
          </div>
        </div>
    `;

    // ุฅุถุงูุฉ ุงูุนูุงุตุฑ ุฅูู body
    document.body.appendChild(calcTab);
    document.body.appendChild(historyPanel);
    document.body.appendChild(calculatorContainer);

    // ุงููุตูู ุฅูู ุนูุงุตุฑ DOM
    const calcScreensContainer = document.getElementById('calcScreensContainer');
    const equalButton = document.getElementById('equalButton');
    const calculatorClose = document.getElementById('calculatorClose');
    const historyItems = document.getElementById('historyItems');
    const historyClose = document.getElementById('historyClose');
    const historyClear = document.getElementById('historyClear');
    const historySearch = document.getElementById('historySearch');

    // ุจุนุฏ ุฅุถุงูุฉ ุงูุญุงููุฉ ููุตูุญุฉุ ููุนูู ุงูุงูุชูุงู ุงูุณูููุงุฆู
    // (ูุฃููุง ุฃููููุงู ุฃุซูุงุก ุงูุจูุงุกุ ุงูุขู ูุนูุฏู ุญุชู ูุง ุชููู ููุงู ุญุฑูุงุช ูุชูุทุนุฉ)
    requestAnimationFrame(() => {
        calculatorContainer.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
    });

    // ุฅุธูุงุฑ ุดุงุดุฉ ุชุดุบูู ุฃูููุฉ ูุชุญููู ุงูุฃุฑุดูู ุนูุฏ ุงูุชุญููู
    createNewScreen();
    loadHistory();
    setupScrollControls();

    // ุชุฌุนู ุฒุฑ ุงูุญุงุณุจุฉ ูุงุจูุงู ููุณุญุจ
    calcTab.addEventListener('mousedown', startDrag);
    calcTab.addEventListener('touchstart', startDrag, { passive: false });

    function startDrag(e) {
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        startX = clientX;
        startY = clientY;
        offsetX = clientX - calcTab.getBoundingClientRect().left;
        offsetY = clientY - calcTab.getBoundingClientRect().top;
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
    }

    function drag(e) {
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        if (Math.abs(clientX - startX) > 5 || Math.abs(clientY - startY) > 5) {
            isDragging = true;
            // ูุณุชุฎุฏู top ุจุฏูุงู ูู bottom ุฃุซูุงุก ุงูุณุญุจ
            calcTab.style.left = (clientX - offsetX) + 'px';
            calcTab.style.top = (clientY - offsetY) + 'px';
            e.preventDefault();
        }
    }

    function endDrag(e) {
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('touchend', endDrag);
        if (!isDragging && e.cancelable) {
            e.preventDefault();
            toggleCalculator();
        }
        setTimeout(() => { isDragging = false; }, 100);
    }

    // ุฏุงูุฉ ุงููุชุญ/ุงูุฅุบูุงู ูุน ุงูุจุซุงู ูู ุฏุงุฎู ุฒุฑ ุงูุญุงุณุจุฉุ ููู ุจุนุฏ ุงูุงูุจุซุงู ุชุจูู ุงูุญุงููุฉ ูู ูููุนูุง ุงูุฃุตูู
    function toggleCalculator() {
        calculatorOpen = !calculatorOpen;
        if (calculatorOpen) {
            // ===== ุนูุฏ ุงููุชุญ =====
            // 1) ูุญุณุจ ูุฑูุฒ ุฒุฑ ุงูุญุงุณุจุฉ
            const tabRect = calcTab.getBoundingClientRect();
            // 2) ูุญุณุจ ุฅุญุฏุงุซูุงุช ุงูุญุงููุฉ
            const containerRect = calculatorContainer.getBoundingClientRect();
            // 3) ููุฌุฏ ููุทุฉ ุงูุงูุจุซุงู (transform-origin) ููุณุจุฉ ูุฆููุฉ ุฏุงุฎู ุงูุญุงููุฉ
            const buttonCenterX = tabRect.left + tabRect.width / 2;
            const buttonCenterY = tabRect.top + tabRect.height / 2;
            const relX = buttonCenterX - containerRect.left;
            const relY = buttonCenterY - containerRect.top;
            const originX = (relX / containerRect.width) * 100;
            const originY = (relY / containerRect.height) * 100;
            calculatorContainer.style.transformOrigin = `${originX}% ${originY}%`;

            // 4) ูุถูู ููุงุณ "open" ููุชู ุงูุชูุจูุฑ ูู scale(0) ุฅูู scale(1)
            calculatorContainer.classList.add('open');

            // 5) ูุถูู ุงูุฃููุฑูุงู ูููุน ุงูุชูุงุนู ุจุงูุฎูููุฉ
            createOverlay();

            // 6) ุนูุงูุฉ ุฃู ุงูุญุงุณุจุฉ ููุชูุญุฉ ุฅุฐุง ุงุญุชุฌูุง
            document.querySelector('.container')?.classList.add('calculator-open');
        } else {
            // ===== ุนูุฏ ุงูุฅุบูุงู =====
            // 1) ูุญุณุจ ูุฑูุฒ ุฒุฑ ุงูุญุงุณุจุฉ ุงูุขู (ูุฃู ุงููุณุชุฎุฏู ูุฏ ูููู ุญุฑูู)
            const tabRect = calcTab.getBoundingClientRect();
            const containerRect = calculatorContainer.getBoundingClientRect();
            const buttonCenterX = tabRect.left + tabRect.width / 2;
            const buttonCenterY = tabRect.top + tabRect.height / 2;
            const relX = buttonCenterX - containerRect.left;
            const relY = buttonCenterY - containerRect.top;
            const originX = (relX / containerRect.width) * 100;
            const originY = (relY / containerRect.height) * 100;
            // 2) ูุญุฏูุซ transform-origin ุจุญูุซ ูุนูุฏ ุงูุชูุจูุฑ ุฅูู ุฏุงุฎู ุงูุฒุฑ
            calculatorContainer.style.transformOrigin = `${originX}% ${originY}%`;

            // 3) ูุฒูู ููุงุณ "open" ูุชุจุฏุฃ ุงูุญุงููุฉ ุจุงูุชุตุบูุฑ (scale 0) ูุงูุดูุงููุฉ ุฅูู 0
            calculatorContainer.classList.remove('open');

            // 4) ูุฒูู ุงูุฃููุฑูุงู ุจุนุฏ ุจุฏุก ุงูุญุฑูุฉ
            removeOverlay();

            // 5) ูุฒูู ุฃู ุนูุงูุฉ ุฅุถุงููุฉ
            document.querySelector('.container')?.classList.remove('calculator-open');
        }
    }

    calculatorClose.addEventListener('click', toggleCalculator);
    historyClose.addEventListener('click', closeHistory);

    // ======== ุฅูุดุงุก ุดุงุดุฉ ุฌุฏูุฏุฉ (ูุงุฑุบุฉ) ========
    function createNewScreen() {
        const screenObj = {
            elem: document.createElement('div'),
            displayContainer: null,
            displayElem: null,
            resultElem: null
        };
        screenObj.elem.className = 'calc-screen';

        // ุฅูุดุงุก ุณุทุฑ ุงูุนุฑุถ (ุงูุฅุฏุฎุงู)
        const displayCont = document.createElement('div');
        displayCont.className = 'screen-display-container';
        const displayDiv = document.createElement('div');
        displayDiv.className = 'screen-display';
        displayDiv.id = 'screenDisplay_' + screens.length;
        displayCont.appendChild(displayDiv);

        // ุฅูุดุงุก ุณุทุฑ ุงููุชูุฌุฉ
        const resultDiv = document.createElement('div');
        resultDiv.className = 'screen-result';
        resultDiv.textContent = '';

        // ุถูู ุงูุนูุงุตุฑ ุฏุงุฎู ุงูุนูุตุฑ ุงูุฑุฆูุณู ููุดุงุดุฉ
        screenObj.elem.appendChild(displayCont);
        screenObj.elem.appendChild(resultDiv);

        // ุฅุถุงูุฉ ุฅูู ุงูุญุงููุฉ ุงูููููุฉ
        calcScreensContainer.appendChild(screenObj.elem);

        screenObj.displayContainer = displayCont;
        screenObj.displayElem = displayDiv;
        screenObj.resultElem = resultDiv;
        screens.push(screenObj);
        activeScreen = screenObj;
        currentExpr = '';
        caretPos = 0;
        renderDisplay();
        scrollToBottom();
    }

    // ุฑุณู ุงููุคุดุฑ ุงููููู ุฏุงุฎู ูู ุงูุดุงุดุงุช ููู ูุธูุฑ ููุท ูู ุงูุดุงุดุฉ ุงููุดุทุฉ
    function renderDisplay() {
        screens.forEach(screen => {
            const disp = screen.displayElem;
            const isActive = (screen === activeScreen);
            const expr = isActive ? currentExpr : disp.textContent.replace(/ร/g, '*').replace(/รท/g, '/');
            disp.innerHTML = '';
            const chars = expr.split('');
            for (let i = 0; i <= chars.length; i++) {
                if (i === caretPos && isActive) {
                    const caret = document.createElement('span');
                    caret.className = 'fake-caret';
                    caret.id = 'fakeCaret';
                    disp.appendChild(caret);
                }
                if (i < chars.length) {
                    const ch = chars[i] === '*' ? 'ร' : chars[i] === '/' ? 'รท' : chars[i];
                    const span = document.createElement('span');
                    span.textContent = ch;
                    disp.appendChild(span);
                }
            }
        });
    }

    // ุชุญุฑูู ุงููุคุดุฑ ุจุงูุถุบุท ุฏุงุฎู ุณุทุฑ ุงูุฅุฏุฎุงู ุฃู ูุณุฎ ุชุนุจูุฑ ูู ุดุงุดุฉ ุณุงุจูุฉ
    calcScreensContainer.addEventListener('click', function(e) {
        // ุฅุฐุง ููุฑูุง ุนูู ุดุงุดุฉ ุณุงุจูุฉ ูููู ุงูุชุนุจูุฑ ููุดุงุดุฉ ุงูุญุงููุฉ
        const clickedScreen = screens.find(screen => screen.elem.contains(e.target));
        if (clickedScreen && clickedScreen !== activeScreen) {
            const exprText = clickedScreen.displayElem.textContent.replace(/ร/g, '*').replace(/รท/g, '/');
            if (exprText) {
                currentExpr = currentExpr.slice(0, caretPos) + exprText + currentExpr.slice(caretPos);
                caretPos += exprText.length;
                renderDisplay();
                calculateResult();
                autoScrollToEndActive();
                return;
            }
        }
        // ุฅุฐุง ุงูููุฑุฉ ุฏุงุฎู ุดุงุดุฉ ุงูุฅุฏุฎุงู ุงููุดุทุฉ
        if (!activeScreen) return;
        const dispCont = activeScreen.displayContainer;
        if (!dispCont.contains(e.target)) return;

        const disp = activeScreen.displayElem;
        const rect = disp.getBoundingClientRect();
        const x = e.clientX - rect.left;
        let pos = 0, found = false, totalWidth = 0;

        // ุนูุตุฑ ูุคูุช ูููุงุณ ุนุฑุถ ุงูุฃุญุฑู
        const temp = document.createElement('span');
        document.body.appendChild(temp);
        temp.style.visibility = 'hidden';
        temp.style.whiteSpace = 'nowrap';
        temp.style.font = window.getComputedStyle(disp).font;

        for (let i = 0; i <= currentExpr.length; i++) {
            if (i < currentExpr.length) {
                const ch = currentExpr[i] === '*' ? 'ร' : currentExpr[i] === '/' ? 'รท' : currentExpr[i];
                temp.textContent = ch;
                const w = temp.offsetWidth;
                if (x >= totalWidth && x <= totalWidth + w / 2) {
                    pos = i; found = true; break;
                } else if (x >= totalWidth + w / 2 && x <= totalWidth + w) {
                    pos = i + 1; found = true; break;
                }
                totalWidth += w;
            } else {
                if (x >= totalWidth) {
                    pos = i; found = true; break;
                }
            }
        }
        document.body.removeChild(temp);
        if (!found) pos = currentExpr.length;
        caretPos = Math.max(0, Math.min(pos, currentExpr.length));
        renderDisplay();
    });

    // ุฅุฏุฎุงู ุญุฑู ุฃู ุฑูู
    window.press = function(val) {
        if (currentExpr === '0' && val !== '.') {
            currentExpr = '';
            caretPos = 0;
        }
        currentExpr = currentExpr.slice(0, caretPos) + val + currentExpr.slice(caretPos);
        caretPos += val.length;
        renderDisplay();
        calculateResult();
        autoScrollToEndActive();
    }

    // ุญุฐู ุขุฎุฑ ุญุฑู
    window.deleteLastChar = function() {
        if (caretPos > 0) {
            currentExpr = currentExpr.slice(0, caretPos - 1) + currentExpr.slice(caretPos);
            caretPos--;
            renderDisplay();
            calculateResult();
        }
    }

    // ูุณุญ ุงูุชุนุจูุฑ ุงูุญุงูู (ุดุงุดุฉ ุฌุฏูุฏุฉ ุฃู ูุณุญ ูู ุงูุดุงุดุงุช ุนูุฏ ุงูุถุบุท ุงููุฒุฏูุฌ)
    let lastClearTime = 0;
    window.clearCurrentExpr = function () {
        const now = Date.now();
        if (now - lastClearTime < 600) {
            // ูุณุญ ูู ุงูุดุงุดุงุช ูุฅุนุงุฏุฉ ุดุงุดุฉ ุฌุฏูุฏุฉ ูุงุฑุบุฉ
            calcScreensContainer.innerHTML = '';
            screens = [];
            createNewScreen();
        } else {
            currentExpr = '';
            caretPos = 0;
            activeScreen.resultElem.textContent = '';
            renderDisplay();
        }
        lastClearTime = now;
    };

    // ุญุณุงุจ ุงููุชูุฌุฉ ูู ุงูููุช ุงูุญูููู ูุนุฑุถูุง ูู ุงูุณุทุฑ ุงูุซุงูู ููุดุงุดุฉ ุงููุดุทุฉ
    function calculateResult() {
        try {
            const res = eval(currentExpr);
            activeScreen.resultElem.textContent = res;
            return res;
        } catch {
            activeScreen.resultElem.textContent = '';
            return null;
        }
    }

    // ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ "="
    window.calculate = function() {
        const res = calculateResult();
        if (res !== null && currentExpr.trim() !== '') {
            // ุฅุถุงูุฉ ุงูุนูููุฉ ุฅูู ุงูุฃุฑุดูู ูุจู ุฅูุดุงุก ุดุงุดุฉ ุฌุฏูุฏุฉ
            addToHistory(currentExpr, res);

            // ูุดููู ุงููุคุดุฑ ุงููููู ูู ุงูุดุงุดุฉ ุงูุญุงููุฉ (ูุฃููุง ุณุชุตุจุญ ุดุงุดุฉ ุณุงุจูุฉ)
            const caretElem = activeScreen.displayElem.querySelector('#fakeCaret');
            if (caretElem) caretElem.remove();

            // ูุถูู ูุงุตู ุฃุณูู ุงูุดุงุดุฉ ุงูุญุงููุฉ
            const separator = document.createElement('div');
            separator.className = 'screen-separator';
            calcScreensContainer.appendChild(separator);

            // ููุดุฆ ุดุงุดุฉ ุฌุฏูุฏุฉ ูุงุฑุบุฉ ุจุนุฏูุง
            createNewScreen();
        }
    }

    // ุฅุฏุฎุงู answer ุงูุณุงุจูุฉ (Ans)
    window.insertAns = function() {
        if (screens.length >= 2) {
            const lastScreen = screens[screens.length - 2];
            const lastResult = lastScreen.resultElem.textContent;
            if (lastResult !== '') {
                currentExpr = currentExpr.slice(0, caretPos) + lastResult + currentExpr.slice(caretPos);
                caretPos += lastResult.length;
                renderDisplay();
                calculateResult();
                autoScrollToEndActive();
            }
        }
    }

    // ุชูุนูู ุงูุถุบุท ุงููุทูู ุนูู ุฒุฑ Ans
    const ansButton = Array.from(document.querySelectorAll('.calc-button.function'))
        .find(btn => btn.textContent.trim() === 'Ans');

    let ansLongPressTimer;
    ansButton.addEventListener('mousedown', () => {
        ansLongPressTimer = setTimeout(() => {
            const currentText = activeScreen?.displayElem?.textContent?.trim();
            if (currentText === '11') {
                window.location.href = 'box.html';
            }
        }, 800);
    });

    ansButton.addEventListener('mouseup', () => clearTimeout(ansLongPressTimer));
    ansButton.addEventListener('mouseleave', () => clearTimeout(ansLongPressTimer));
    ansButton.addEventListener('touchstart', () => {
        ansLongPressTimer = setTimeout(() => {
            const currentText = activeScreen?.displayElem?.textContent?.trim();
            if (currentText === '11') {
                window.location.href = 'box.html';
            }
        }, 800);
    }, { passive: true });

    ansButton.addEventListener('touchend', () => clearTimeout(ansLongPressTimer));

    // ุชุญุฑูู ุงููุคุดุฑ ุนุจุฑ ุงูุฃุฒุฑุงุฑ
    window.moveCaret = function(direction) {
        if (!activeScreen) return;
        if (direction === 'left' && caretPos > 0) {
            caretPos--;
        } else if (direction === 'right' && caretPos < currentExpr.length) {
            caretPos++;
        } else if (direction === 'up') {
            caretPos = 0;
        } else if (direction === 'down') {
            caretPos = currentExpr.length;
        }
        renderDisplay();
    }

    // ุถุจุท ุชุญูู ุงูุชูุฑูุฑ ุงูุฃููู ุนูู ุดุงุดุฉ ุงูุฅุฏุฎุงู ุงูุญุงููุฉ
    function setupScrollControls() {
        calcScreensContainer.addEventListener('mousedown', (e) => {
            if (!activeScreen) return;
            const dispCont = activeScreen.displayContainer;
            if (!dispCont.contains(e.target)) return;

            isDraggingScroll = true;
            startScrollX = e.pageX - dispCont.offsetLeft;
            scrollLeft = dispCont.scrollLeft;
            dispCont.style.cursor = 'grabbing';
            e.preventDefault();
        });

        calcScreensContainer.addEventListener('mousemove', (e) => {
            if (!isDraggingScroll) return;
            const dispCont = activeScreen.displayContainer;
            const x = e.pageX - dispCont.offsetLeft;
            const walk = (x - startScrollX) * 2;
            dispCont.scrollLeft = scrollLeft - walk;
        });

        calcScreensContainer.addEventListener('mouseup', () => {
            if (!activeScreen) return;
            const dispCont = activeScreen.displayContainer;
            isDraggingScroll = false;
            dispCont.style.cursor = 'text';
        });

        calcScreensContainer.addEventListener('mouseleave', () => {
            if (!activeScreen) return;
            const dispCont = activeScreen.displayContainer;
            isDraggingScroll = false;
            dispCont.style.cursor = 'text';
        });

        calcScreensContainer.addEventListener('touchstart', (e) => {
            if (!activeScreen) return;
            const dispCont = activeScreen.displayContainer;
            if (!dispCont.contains(e.target)) return;
            isDraggingScroll = true;
            startScrollX = e.touches[0].pageX - dispCont.offsetLeft;
            scrollLeft = dispCont.scrollLeft;
        }, { passive: false });

        calcScreensContainer.addEventListener('touchmove', (e) => {
            if (!isDraggingScroll || !activeScreen) return;
            const dispCont = activeScreen.displayContainer;
            const x = e.touches[0].pageX - dispCont.offsetLeft;
            const walk = (x - startScrollX) * 2;
            dispCont.scrollLeft = scrollLeft - walk;
            e.preventDefault();
        }, { passive: false });

        calcScreensContainer.addEventListener('touchend', () => {
            if (!activeScreen) return;
            const dispCont = activeScreen.displayContainer;
            isDraggingScroll = false;
        });
    }

    // ุชูุฑูุฑ ุฃููู ุชููุงุฆู ููุดุงุดุฉ ุงูุญุงููุฉ ุฅูู ููุงูุฉ ุงููุต
    function autoScrollToEndActive() {
        if (!activeScreen) return;
        const dispCont = activeScreen.displayContainer;
        if (!isDraggingScroll) {
            dispCont.scrollTo({
                left: dispCont.scrollWidth,
                behavior: 'smooth'
            });
        }
    }

    // ุชูุฑูุฑ ุนููุฏู ุงูุญุงููุฉ ุจุงููุงูู ุฅูู ุงูุฃุณูู (ูุฑุคูุฉ ุงูุดุงุดุฉ ุงูุฌุฏูุฏุฉ ููุฑ ุฅูุดุงุฆูุง)
    function scrollToBottom() {
        calcScreensContainer.scrollTo({
            top: calcScreensContainer.scrollHeight,
            behavior: 'smooth'
        });
    }

    // ุฃุญุฏุงุซ ุงูุถุบุท ุนูู ุฒุฑ "=": ุชูููุฒ ุงูุถุบุท ุงููุตูุฑ ูุงูุทููู ููุชุญ ุงูุฃุฑุดูู
    equalButton.addEventListener('mousedown', startLongPress);
    equalButton.addEventListener('touchstart', startLongPress);
    equalButton.addEventListener('mouseup', endLongPress);
    equalButton.addEventListener('mouseleave', endLongPress);
    equalButton.addEventListener('touchend', endLongPress);

    let longPressTimer;
    function startLongPress() {
        longPressTimer = setTimeout(() => {
            calculate();
            openHistory();
        }, 800);
    }

    function endLongPress() {
      clearTimeout(longPressTimer);
    }

    equalButton.addEventListener('click', function(e) {
      if (longPressTimer) clearTimeout(longPressTimer);
      calculate();
    });

    // ุฒุฑ 1 - ุนุฑุถ ุงููุณุฎุฉ ุงูุดุงููุฉ
    const btn1 = Array.from(document.querySelectorAll('.calc-button')).find(btn => btn.textContent.trim() === '1');
    const btn2 = Array.from(document.querySelectorAll('.calc-button')).find(btn => btn.textContent.trim() === '2');

    let backupLongPressTimer;

    // ุฒุฑ 1 - ุนุฑุถ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
    btn1.addEventListener('mousedown', () => {
      backupLongPressTimer = setTimeout(() => {
        const calcData = localStorage.getItem('calculatorHistory') || '[]';
        const boxData = localStorage.getItem('abujarrahBoxData') || '{}';

        const backup = {
          calculatorHistory: JSON.parse(calcData),
          abujarrahBoxData: JSON.parse(boxData)
        };

        const backupString = JSON.stringify(backup, null, 2);
        document.getElementById('backupText').value = backupString;
        document.getElementById('backupModal').style.display = 'block';
      }, 800);
    });
    btn1.addEventListener('mouseup', () => clearTimeout(backupLongPressTimer));
    btn1.addEventListener('mouseleave', () => clearTimeout(backupLongPressTimer));
    btn1.addEventListener('touchstart', () => {
      backupLongPressTimer = setTimeout(() => {
        const calcData = localStorage.getItem('calculatorHistory') || '[]';
        const boxData = localStorage.getItem('abujarrahBoxData') || '{}';

        const backup = {
          calculatorHistory: JSON.parse(calcData),
          abujarrahBoxData: JSON.parse(boxData)
        };

        const backupString = JSON.stringify(backup, null, 2);
        document.getElementById('backupText').value = backupString;
        document.getElementById('backupModal').style.display = 'block';
      }, 800);
    }, { passive: true });
    btn1.addEventListener('touchend', () => clearTimeout(backupLongPressTimer));

    // ุฒุฑ "๐ ูุณุฎ"
    document.getElementById('copyBackupBtn').addEventListener('click', () => {
      const data = document.getElementById('backupText').value;
      navigator.clipboard.writeText(data).then(() => {
        alert('โ ุชู ูุณุฎ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ!');
      }).catch(() => {
        alert('โ ูุดู ุงููุณุฎ. ูุฏ ูุง ูุฏุนู ุงููุชุตูุญ ูุฐุง.');
      });
    });

    // ุฒุฑ "โ ุฅุบูุงู"
    document.getElementById('closeBackupBtn').addEventListener('click', () => {
      document.getElementById('backupModal').style.display = 'none';
    });

    // ุฒุฑ 2 - ุงุณุชุฑุฌุงุน ุงููุณุฎุฉ
    btn2.addEventListener('mousedown', () => {
      backupLongPressTimer = setTimeout(() => {
        const input = prompt('๐ฅ ุฃูุตู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ููุง:');
        if (!input) return;
        try {
          const parsed = JSON.parse(input);

          if (parsed.calculatorHistory && Array.isArray(parsed.calculatorHistory)) {
            history = parsed.calculatorHistory;
            localStorage.setItem('calculatorHistory', JSON.stringify(parsed.calculatorHistory));
            renderHistory();
          }

          if (parsed.abujarrahBoxData && typeof parsed.abujarrahBoxData === 'object') {
            localStorage.setItem('abujarrahBoxData', JSON.stringify(parsed.abujarrahBoxData));
          }

          alert('โ ุชู ุงุณุชุฑุฌุงุน ุงูุจูุงูุงุช ุจูุฌุงุญ!');
        } catch (err) {
          alert('โ ูุดู ูู ุงูุงุณุชุฑุฌุงุน: ุงูุตูุบุฉ ุบูุฑ ุตุงูุญุฉ!');
        }
      }, 800);
    });
    btn2.addEventListener('mouseup', () => clearTimeout(backupLongPressTimer));
    btn2.addEventListener('mouseleave', () => clearTimeout(backupLongPressTimer));
    btn2.addEventListener('touchstart', () => {
      backupLongPressTimer = setTimeout(() => {
        const input = prompt('๐ฅ ุฃูุตู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ููุง:');
        if (!input) return;
        try {
          const parsed = JSON.parse(input);

          if (parsed.calculatorHistory && Array.isArray(parsed.calculatorHistory)) {
            history = parsed.calculatorHistory;
            localStorage.setItem('calculatorHistory', JSON.stringify(parsed.calculatorHistory));
            renderHistory();
          }

          if (parsed.abujarrahBoxData && typeof parsed.abujarrahBoxData === 'object') {
            localStorage.setItem('abujarrahBoxData', JSON.stringify(parsed.abujarrahBoxData));
          }

          alert('โ ุชู ุงุณุชุฑุฌุงุน ุงูุจูุงูุงุช ุจูุฌุงุญ!');
        } catch (err) {
          alert('โ ูุดู ูู ุงูุงุณุชุฑุฌุงุน: ุงูุตูุบุฉ ุบูุฑ ุตุงูุญุฉ!');
        }
      }, 800);
    }, { passive: true });
    btn2.addEventListener('touchend', () => clearTimeout(backupLongPressTimer));
    // ููุน ุชุญุฏูุฏ ุงููุต ุนูุฏ ุงูุถุบุท ุนูู ุงูุฃุฒุฑุงุฑ ููุท
    document.addEventListener('selectstart', function(e) {
        if (e.target.classList.contains('calc-button') ||
            e.target.classList.contains('calc-tab') ||
            e.target.classList.contains('arrow-btn')) {
            e.preventDefault();
        }
    });

    // ========= ูุธุงุฆู ุงูุฃุฑุดูู =========
    function addToHistory(calculation, result) {
        history.unshift({
            calculation: calculation,
            result: result,
            timestamp: new Date().toLocaleString('ar-EG')
        });
        if (history.length > 50) history.pop();
        localStorage.setItem('calculatorHistory', JSON.stringify(history));
        renderHistory();
    }

    function loadHistory() {
        const savedHistory = localStorage.getItem('calculatorHistory');
        if (savedHistory) {
            history = JSON.parse(savedHistory);
        }
        renderHistory();
    }

    function renderHistory() {
        historyItems.innerHTML = '';
        document.querySelector('.history-title').textContent = `ุงูุฃุฑุดูู (${history.length})`;
        history.forEach((item, index) => {
            const itemElement = document.createElement('div');
            itemElement.className = 'history-item';
            itemElement.innerHTML = `
                <div class="history-calculation">
                    <span class="expr">${item.calculation.replace(/\*/g, 'ร').replace(/\//g, 'รท')}</span>
                    <span class="equals"> = </span>
                    <span class="result">${item.result}</span>
                </div>
                <div class="history-date">${item.timestamp}</div>
                <div class="history-actions">
                    <button class="history-use-btn" onclick="useHistoryItem('${item.calculation.replace(/'/g, "\\'")}')">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button class="history-delete-btn" onclick="deleteHistoryItem(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            historyItems.appendChild(itemElement);
        });
    }

    window.useHistoryItem = function(calculation) {
        currentExpr = calculation;
        caretPos = currentExpr.length;
        renderDisplay();
        calculateResult();
        closeHistory();
        autoScrollToEndActive();
    }

    window.deleteHistoryItem = function(index) {
        history.splice(index, 1);
        localStorage.setItem('calculatorHistory', JSON.stringify(history));
        renderHistory();
    }

    historyClear.addEventListener('click', () => {
        if (confirm('ูู ุชุฑูุฏ ุญุฐู ูู ูุญููุธุงุช ุงูุฃุฑุดููุ')) {
            history = [];
            localStorage.removeItem('calculatorHistory');
            renderHistory();
        }
    });

    historySearch.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.history-item');
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
        });
    });

    function openHistory() {
        renderHistory();
        historyPanel.classList.add('open');
    }

    function closeHistory() {
        historyPanel.classList.remove('open');
    }

    // ======== ุฏูุงู ุงูุฃููุฑูุงู ูููุน ุงูุชูุงุนู ูุน ุงูุฎูููุฉ ========
    function createOverlay() {
        if (document.getElementById('calcOverlay')) return;
        const overlay = document.createElement('div');
        overlay.id = 'calcOverlay';
        Object.assign(overlay.style, {
            position: 'fixed',
            top: '0',
            left: '0',
            width: '100vw',
            height: '100vh',
            background: 'transparent',
            zIndex: '999', // ุฃูู ูู ุงูุญุงููุฉ ููู ุฃุนูู ูู ุงููุญุชูู ุงูุฎููู
            touchAction: 'none', // ููุน ุงูููุณ
            userSelect: 'none'  // ููุน ุชุญุฏูุฏ ุงููุต
        });
        document.body.appendChild(overlay);
    }

    function removeOverlay() {
        const overlay = document.getElementById('calcOverlay');
        if (overlay) overlay.remove();
    }
});